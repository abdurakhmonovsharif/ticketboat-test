#########################################################
# Configuration
#########################################################
# Used to identify the application in AWS resources | allowed characters: a-zA-Z0-9-_
# NOTE: This should always include the ENVIRONMENT
export APP_IDENT_WITHOUT_ENV=ticketboat-admin-api

# This is the AWS S3 bucket in which you are storing your terraform state files
# - This must exist before deploying
export TERRAFORM_STATE_BUCKET=ticketboat-terraform-state

# This is the AWS region in which the application will be deployed
export AWS_DEFAULT_REGION=us-east-1

# OIDC Deployment role
export AWS_ROLE_ARN=arn:aws:iam::317822790556:role/bitbucket-pipelines-cd-yqpfbe
export AWS_WEB_IDENTITY_TOKEN_FILE=$(pwd)/web-identity-token
echo $BITBUCKET_STEP_OIDC_TOKEN > $(pwd)/web-identity-token

# Lambda timeout and memory settings
export APP_TIMEOUT=30  # seconds
export APP_MEMORY=512  # memory in MB

# Alarm Settings
export SNS_TOPIC_FOR_ALARMS=Opsgenie_staging
export EXPECT_SUCCESS_AT_LEAST_EVERY_N_MINUTES=65

# Domain Settings
export API_ROOT_DOMAIN=ticketboat-admin.com

# Used in Lambda and Redis configs
export VPC_NAME=ticketboat-standard-vpc
export PRIVATE_SUBNET_IDS='["subnet-0d769500ae6f97d3a", "subnet-069346a6c319fc144", "subnet-060cc02861b17266f"]'
export PUBLIC_SUBNET_IDS='["subnet-006513fa27a60b74b", "subnet-0cc7ef7d721e560cd", "subnet-0dd1bc8caf246299c"]'

# Snowflake settings
export SNOWFLAKE_ACCOUNT=oxb71458.us-east-1
export SNOWFLAKE_WAREHOUSE=USER_FACING_WH
export SNOWFLAKE_ROLE=developer
export SNOWFLAKE_USER=TICKETBOAT_ADMIN_API2

export AZURE_TENANT_ID=d52047ce-6b9c-4bf1-bd4e-fa9fcf025c12
export AZURE_AD_APP_ID=1e7c3684-aed2-4329-bb69-497e727eaeab
export AZURE_AUTHORITY_URL=https://login.microsoftonline.com/organizations
export AZURE_SCOPE_BASE='["https://analysis.windows.net/powerbi/api/.default"]'

export VIAGOGO_API_TOKEN="eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOjU4OSwidCI6MSwiZXhwIjoyMDQyMDQyODQ2LCJhZ3QiOiJGcS9OcmVob3p5NEI4OGNiL25YeUxWL1UzWkVlU3FDdkx5ZE5nM0hOdmQ4PSIsImIiOjIzODc5fQ.bSsWIDh2TSccuydIH-ib-r5Pb2C2uiV5yvIJZcJ98TyNJvg4fEy-m6jqIxeDEFPQEHDtjbfPP5T2fVfry5aORyw3kkO2yHR-JtAzy9gSmQK2H36A1Xh_4657HKOibYINI0nPuncewW4JXLYUgcn9NzsK0KXiXQVJlMFkRHCnaurcY9ufQw2-SEGx9PLGDTtbZKsjWJMd5Rs3DqrYFQCUjrTxgk-buZmA-1rkJxKRoj2yIkP1Xd7sS_qwnlloKCjnXV8u-G64clW5RdQjRJCYGx_9loeUPG0EqmaZcy-_REmU0-S7L9B3_p27KwaY4lDCnun1Hm7sWRhyDjXdMhlb-Q"

export VAULTWARDEN_URL=https://vault.ticketboat-admin.com
export CC_ENCRYPTION_KEY_FOR_STORAGE=${CC_ENCRYPTION_KEY_FOR_STORAGE}
export CC_MASTER_ENCRYPTION_KEY=${CC_MASTER_ENCRYPTION_KEY}

export TRADE_DESK_BROKER_KEY=7Z78qm8Kjc0

#########################################################
# Create code hash
# NOTE:
#   - When the code changes a new code hash file should be created
#   - The find command here should be configured so that it finds all files such that if they change a re-build
#     and deploy should occur
#########################################################
export CODE_HASH_FILE=code_hash.txt
docker run -v $(pwd):/workdir -w /workdir alpine sh -c \
  "apk add --no-cache findutils coreutils && find ./requirements.txt ./Dockerfile ./.env.* ./src -type f \( -name '*.py' -o -name 'Dockerfile' -o -name 'requirements.txt' \) -not -path '*/.*' -exec md5sum {} \\; | sort | md5sum | cut -d ' ' -f1 > terraform/${CODE_HASH_FILE}"
